<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotel Palermo Soho â€” AI Agents</title>
  <style>
    :root {
      --navy:    #4401ff;
      --navy2:   #6630ff;
      --gold:    #C9A227;
      --cream:   #F5F3FF;
      --wa-bg:   #EBEBEB;
      --wa-sent: #E0D4FF;
      --wa-recv: #FFFFFF;
      --wa-hdr:  #4401ff;
      --wa-tabs: #6630ff;
      --wa-grn:  #4401ff;
      --wa-send: #4401ff;
      --wa-blue: #4401ff;
      --text:    #111B21;
      --muted:   #666666;
      --shadow:  0 28px 80px rgba(68,1,255,.22);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--cream);
      min-height: 100vh;
    }

    /* â”€â”€ PAGE HEADER â”€â”€ */
    .page-header {
      text-align: center;
      background: var(--navy);
      padding: 32px 20px 52px;
      clip-path: ellipse(120% 100% at 50% 0%);
      margin-bottom: -24px;
    }
    .page-header .eyebrow { font-size:10px; letter-spacing:3.5px; text-transform:uppercase; color:var(--gold); margin-bottom:8px; }
    .page-header h1 { font-size:26px; font-weight:700; color:#fff; line-height:1.25; }
    .page-header p  { font-size:13px; color:rgba(255,255,255,.5); margin-top:6px; }

    /* â”€â”€ LAYOUT â”€â”€ */
    .demo-layout {
      display: grid;
      grid-template-columns: 255px 390px 255px;
      gap: 20px;
      max-width: 970px;
      margin: 0 auto;
      padding: 24px 16px 48px;
      align-items: start;
    }
    @media(max-width:920px) {
      .demo-layout { grid-template-columns:1fr; justify-items:center; }
      .side-panel { display:none!important; }
    }

    /* â”€â”€ PHONE FRAME â”€â”€ */
    .phone {
      width: 390px; height: 780px;
      background: #111B21;
      border-radius: 44px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255,255,255,.07);
    }

    /* Status bar */
    .status-bar {
      background: var(--wa-hdr);
      padding: 10px 22px 6px;
      display: flex; justify-content:space-between; align-items:center;
      flex-shrink: 0;
    }
    .sb-time  { color:#fff; font-size:13px; font-weight:600; }
    .sb-icons { color:#fff; font-size:11px; display:flex; gap:5px; align-items:center; }

    /* WhatsApp-style header */
    .wa-header {
      background: var(--wa-hdr);
      padding: 8px 12px 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .wa-back { color:rgba(255,255,255,.85); font-size:20px; cursor:pointer; flex-shrink:0; }
    .wa-av {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, var(--gold), #a67c00);
      display:flex; align-items:center; justify-content:center;
      font-size: 19px; flex-shrink:0; cursor:pointer;
    }
    .wa-info { flex:1; min-width:0; }
    .wa-name { color:#fff; font-size:15px; font-weight:600; line-height:1.2; }
    .wa-sub  { font-size:12px; color:rgba(255,255,255,.7); margin-top:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .wa-actions { display:flex; gap:18px; align-items:center; color:rgba(255,255,255,.85); font-size:20px; }
    .wa-actions span { cursor:pointer; }

    /* Tabs */
    .wa-tabs {
      background: var(--wa-tabs);
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 10px 2px 9px;
      text-align: center;
      font-size: 10.5px; font-weight: 500;
      color: rgba(255,255,255,.6);
      cursor: pointer;
      border-bottom: 2.5px solid transparent;
      text-transform: uppercase; letter-spacing:.5px;
      line-height: 1.35; user-select: none;
      transition: all .18s;
    }
    .tab-btn.active { color:#fff; border-bottom-color:#fff; }
    .tab-btn:not(.active):hover { background: rgba(255,255,255,.08); }

    /* â”€â”€ CHAT AREA â”€â”€ */
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 8px 8px 6px;
      background: var(--wa-bg);
      /* WhatsApp wallpaper subtle texture */
      background-image:
        radial-gradient(circle at 1px 1px, rgba(0,0,0,.04) 1px, transparent 0);
      background-size: 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .chat-area::-webkit-scrollbar { width:3px; }
    .chat-area::-webkit-scrollbar-thumb { background:rgba(0,0,0,.2); border-radius:2px; }

    /* Date chip */
    .date-chip { text-align:center; margin:6px 0; }
    .date-chip span {
      background: #e1f2fb;
      color: #54656F;
      font-size: 11.5px;
      padding: 4px 10px;
      border-radius: 7px;
      box-shadow: 0 1px 1px rgba(0,0,0,.06);
    }

    /* â”€â”€ BUBBLES â”€â”€ */
    .msg-row { display:flex; margin: 1px 4px; }
    .msg-row.agent { justify-content:flex-start; }
    .msg-row.user  { justify-content:flex-end; }

    .msg-bubble {
      position: relative;
      max-width: 82%;
      padding: 6px 10px 4px;
      font-size: 14px;
      line-height: 1.45;
      color: var(--text);
      word-break: break-word;
      box-shadow: 0 1px 1px rgba(0,0,0,.13);
    }

    /* Received (agent) */
    .msg-row.agent .msg-bubble {
      background: var(--wa-recv);
      border-radius: 0px 8px 8px 8px;
    }
    .msg-row.agent .msg-bubble::before {
      content: '';
      position: absolute;
      top: 0; left: -8px;
      width: 8px; height: 13px;
      background: var(--wa-recv);
      clip-path: polygon(100% 0, 100% 100%, 0 0);
    }

    /* Sent (user) */
    .msg-row.user .msg-bubble {
      background: var(--wa-sent);
      border-radius: 8px 0px 8px 8px;
    }
    .msg-row.user .msg-bubble::before {
      content: '';
      position: absolute;
      top: 0; right: -8px;
      width: 8px; height: 13px;
      background: var(--wa-sent);
      clip-path: polygon(0 0, 0 100%, 100% 0);
    }

    /* Timestamp + ticks inside bubble */
    .bubble-meta {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      float: right;
      margin-left: 8px;
      margin-top: 2px;
      position: relative;
      bottom: -2px;
    }
    .btime  { font-size: 11px; color: var(--muted); }
    .bticks { font-size: 12px; color: var(--wa-blue); line-height: 1; }

    /* Typing indicator */
    .typing-row { display:flex; margin: 1px 4px; }
    .typing-bub {
      background: var(--wa-recv);
      border-radius: 0px 8px 8px 8px;
      padding: 10px 14px;
      display: flex; gap: 4px; align-items: center;
      box-shadow: 0 1px 1px rgba(0,0,0,.13);
      position: relative;
    }
    .typing-bub::before {
      content: '';
      position: absolute;
      top: 0; left: -8px;
      width: 8px; height: 13px;
      background: var(--wa-recv);
      clip-path: polygon(100% 0, 100% 100%, 0 0);
    }
    .td { width:8px; height:8px; border-radius:50%; background:#666666; animation:bounce 1.4s infinite ease-in-out; }
    .td:nth-child(2) { animation-delay:.2s; }
    .td:nth-child(3) { animation-delay:.4s; }

    /* â”€â”€ INLINE CARDS â”€â”€ */
    /* Room cards */
    .room-opts { display:flex; flex-direction:column; gap:5px; margin-top:8px; }
    .room-opt { background:#f0f0f0; border-radius:8px; overflow:hidden; border:1px solid rgba(0,0,0,.08); }
    .room-opt-h { background:#4401ff; padding:6px 10px; display:flex; justify-content:space-between; align-items:center; }
    .room-opt-h .rn { color:#fff; font-size:12.5px; font-weight:600; }
    .room-opt-h .rp { color:var(--gold); font-size:13px; font-weight:700; }
    .room-opt-b { padding:6px 10px; display:flex; gap:4px; flex-wrap:wrap; }
    .rtag { background:#fff; padding:2px 7px; border-radius:6px; font-size:11px; color:#333; border:1px solid rgba(0,0,0,.06); }

    /* Confirmation card */
    .conf-card { background:linear-gradient(135deg,#059669,#047857); border-radius:10px; padding:12px; color:#fff; margin-top:6px; }
    .conf-title { font-size:13.5px; font-weight:700; margin-bottom:9px; display:flex; align-items:center; gap:5px; }
    .conf-row { display:flex; justify-content:space-between; font-size:12px; margin-bottom:3px; opacity:.9; }
    .conf-num { background:rgba(255,255,255,.2); border-radius:7px; padding:7px 10px; text-align:center; font-size:15px; font-weight:700; letter-spacing:2px; margin-top:9px; }

    /* Reception topics */
    .topics-area { display:flex; flex-direction:column; gap:4px; margin-top:6px; }
    .q-topic {
      background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:8px;
      padding:8px 12px; display:flex; align-items:center; gap:9px;
      cursor:pointer; transition:all .15s; font-size:13px; color:var(--text);
      box-shadow:0 1px 1px rgba(0,0,0,.06);
    }
    .q-topic:hover { background:#f0fdf4; border-color:var(--wa-grn); }
    .q-topic .qi { font-size:17px; width:22px; text-align:center; flex-shrink:0; }

    /* Upsell */
    .revenue-banner {
      background: linear-gradient(135deg, #4401ff, #6630ff);
      margin: -8px -8px 8px;
      padding: 16px;
      text-align: center;
    }
    .rev-label { font-size:10px; text-transform:uppercase; letter-spacing:2px; color:rgba(255,255,255,.55); margin-bottom:3px; }
    .rev-amt   { font-size:30px; font-weight:700; color:#7c3aff; font-variant-numeric:tabular-nums; transition:transform .2s; }
    .rev-sub   { font-size:10.5px; color:rgba(255,255,255,.4); margin-top:2px; }

    .upsell-card { background:#fff; border-radius:10px; overflow:hidden; border:1px solid rgba(0,0,0,.08); margin-bottom:6px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .upsell-h { background:linear-gradient(135deg,#4401ff,#6630ff); padding:9px 13px; display:flex; justify-content:space-between; align-items:center; }
    .upsell-title { color:#fff; font-size:13px; font-weight:600; }
    .upsell-badge { background:var(--gold); color:#4401ff; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700; }
    .upsell-body { padding:9px 13px; }
    .upsell-desc { font-size:12px; color:var(--muted); margin-bottom:9px; line-height:1.5; }
    .upsell-actions { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .btn-yes {
      padding:7px; background:#4401ff; color:#fff; border:none; border-radius:7px;
      font-size:12.5px; font-weight:600; cursor:pointer; transition:all .2s; font-family:inherit;
    }
    .btn-yes:hover:not([disabled]) { background:#6630ff; }
    .btn-no {
      padding:7px; background:transparent; color:var(--muted); border:1px solid #ddd;
      border-radius:7px; font-size:12.5px; cursor:pointer; font-family:inherit; transition:all .15s;
    }
    .btn-no:hover:not([disabled]) { background:#f5f5f5; }

    /* â”€â”€ SUGGESTIONS (quick reply chips) â”€â”€ */
    .suggestions-area {
      padding: 6px 8px;
      display: flex; gap: 6px; flex-wrap: wrap;
      background: #1F2C33;
      border-top: 1px solid rgba(255,255,255,.06);
      flex-shrink: 0;
      min-height: 46px;
      align-items: center;
    }
    .sugg-btn {
      padding: 5px 12px;
      border: 1px solid var(--wa-grn);
      border-radius: 18px;
      font-size: 12px; color: var(--wa-grn);
      background: transparent;
      cursor: pointer; transition: all .15s;
      font-weight: 500; white-space: nowrap; font-family: inherit;
    }
    .sugg-btn:hover { background: var(--wa-grn); color: #fff; }

    /* â”€â”€ INPUT BAR â”€â”€ */
    .input-bar {
      padding: 8px 10px;
      display: flex; align-items: center; gap: 8px;
      background: #1F2C33;
      flex-shrink: 0;
    }
    .ib-emoji {
      font-size: 23px; cursor: pointer; color: #666666; flex-shrink:0;
      background: none; border: none; padding: 0; line-height:1;
    }
    .ib-field {
      flex: 1;
      background: #2A3942;
      border: none; border-radius: 22px;
      padding: 9px 14px;
      font-size: 14px; color: #D1D7DB;
      outline: none; font-family: inherit;
    }
    .ib-field::placeholder { color: #666666; }
    .ib-attach { font-size:22px; cursor:pointer; color:#666666; flex-shrink:0; background:none; border:none; padding:0; }
    .ib-send {
      width: 44px; height: 44px;
      background: var(--wa-send);
      border: none; border-radius: 50%;
      color: #fff;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 19px; flex-shrink: 0;
      transition: background .2s;
    }
    .ib-send:hover { background: #008f6e; }
    .ib-send.mic { font-size: 20px; }

    /* â”€â”€ SIDE PANELS â”€â”€ */
    .side-panel { padding-top: 20px; }
    .panel-card { background:#fff; border-radius:20px; padding:22px; box-shadow:0 8px 32px rgba(11,37,69,.09); }
    .panel-title { font-size:15px; font-weight:700; color:#666666; margin-bottom:3px; }
    .panel-sub   { font-size:12px; color:#999; margin-bottom:18px; }

    .roi-num { margin-bottom:14px; }
    .roi-lbl  { font-size:10.5px; text-transform:uppercase; letter-spacing:1.5px; color:#999; margin-bottom:2px; }
    .roi-val  { font-size:26px; font-weight:700; color:#666666; }
    .roi-unit { font-size:13px; color:#999; font-weight:400; }
    .roi-div  { height:1px; background:#e8e8e8; margin:14px 0; }
    .slider-row { display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:5px; }
    .roi-slider { width:100%; accent-color:#666666; margin-bottom:14px; cursor:pointer; }
    .roi-box { background:#666666; border-radius:12px; padding:16px; text-align:center; margin-top:14px; }
    .roi-box .rv { font-size:28px; font-weight:700; color:#fff; }
    .roi-box .rl { font-size:11px; color:rgba(255,255,255,.6); margin-top:3px; }

    .feat-item { display:flex; gap:12px; margin-bottom:14px; align-items:flex-start; }
    .feat-icon { width:38px; height:38px; background:#f5f5f5; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:19px; flex-shrink:0; }
    .feat-text h4 { font-size:13px; font-weight:600; color:#444; margin-bottom:2px; }
    .feat-text p  { font-size:11.5px; color:#999; line-height:1.4; }
    .cta-btn {
      width:100%; padding:13px;
      background:#666666; color:#fff; border:none;
      border-radius:10px; font-size:14px; font-weight:700;
      cursor:pointer; margin-top:6px; transition:all .2s; font-family:inherit;
    }
    .cta-btn:hover { background:#555; transform:translateY(-1px); box-shadow:0 4px 14px rgba(0,0,0,.2); }

    /* â”€â”€ CHECK-IN CARD â”€â”€ */
    .ci-card {
      background: linear-gradient(135deg, #4401ff, #6630ff);
      border-radius: 14px; padding: 14px; color: #fff; margin-top: 6px;
    }
    .ci-card-title { font-size:14px; font-weight:700; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
    .ci-row { display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,.1); padding-bottom:5px; }
    .ci-row:last-of-type { border-bottom:none; }
    .ci-row span:first-child { color:rgba(255,255,255,.6); }
    .ci-row span:last-child  { font-weight:600; text-align:right; }
    .ci-key {
      background: linear-gradient(135deg, var(--gold), #a67c00);
      border-radius: 10px; padding: 10px 14px; margin-top: 12px;
      display: flex; align-items: center; gap: 10px;
    }
    .ci-key .key-icon { font-size: 26px; }
    .ci-key .key-text { font-size:12px; color:#4401ff; }
    .ci-key .key-num  { font-size:16px; font-weight:700; color:#4401ff; letter-spacing:2px; }

    /* Progress bar */
    .ci-progress {
      background: rgba(255,255,255,.15); border-radius: 20px;
      height: 4px; margin-bottom: 10px; overflow: hidden;
    }
    .ci-progress-fill {
      background: var(--gold); height: 100%; border-radius: 20px;
      transition: width .4s ease;
    }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes fadeUp   { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    @keyframes pulse    { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.8)} }
    @keyframes bounce   { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-8px)} }
    .msg-row { animation: fadeUp .25s ease; }
  </style>
</head>
<body>

<!-- PAGE HEADER -->
<header class="page-header">
  <div class="eyebrow">AI-Powered Guest Experience</div>
  <h1>Hotel Palermo Soho â€” AI Agents</h1>
  <p>Tres agentes inteligentes gestionando reservas, concierge y upselling 24/7</p>
</header>

<div class="demo-layout">

  <!-- LEFT: ROI Calculator -->
  <aside class="side-panel">
    <div class="panel-card">
      <div class="panel-title">Calculadora de ROI</div>
      <div class="panel-sub">AjustÃ¡ para tu propiedad</div>

      <div class="slider-row">
        <span>TamaÃ±o del hotel</span>
        <span id="roomsValue">50 habitaciones</span>
      </div>
      <input type="range" class="roi-slider" id="roomsSlider" min="10" max="200" value="50" oninput="updateROI()" />

      <div class="roi-num">
        <div class="roi-lbl">Horas de staff ahorradas / semana</div>
        <div class="roi-val" id="hoursValue">28<span class="roi-unit"> hrs</span></div>
      </div>
      <div class="roi-num">
        <div class="roi-lbl">Revenue extra de upselling / mes</div>
        <div class="roi-val" id="revenueValue">$5,500</div>
      </div>
      <div class="roi-num">
        <div class="roi-lbl">Consultas resueltas automÃ¡ticamente</div>
        <div class="roi-val">82<span class="roi-unit">%</span></div>
      </div>
      <div class="roi-div"></div>
      <div class="roi-box">
        <div class="rv" id="totalValue">$5,500/mes</div>
        <div class="rl">revenue adicional en tu propiedad</div>
      </div>
    </div>
  </aside>

  <!-- CENTER: Phone -->
  <div class="phone">

    <!-- Status bar -->
    <div class="status-bar">
      <div class="sb-time">9:41</div>
      <div class="sb-icons"><span>â—â—â—â—</span><span>WiFi</span><span>ğŸ”‹</span></div>
    </div>

    <!-- WhatsApp header -->
    <div class="wa-header">
      <div class="wa-back">â€¹</div>
      <div class="wa-av" id="agIcon">ğŸ¨</div>
      <div class="wa-info">
        <div class="wa-name" id="agName">Velora â€” Reservas</div>
        <div class="wa-sub"  id="agSub">en lÃ­nea</div>
      </div>
      <div class="wa-actions">
        <span title="Video call">ğŸ“¹</span>
        <span title="Call">ğŸ“</span>
        <span title="Menu">â‹®</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="wa-tabs">
      <div class="tab-btn active" onclick="switchTab('reservations')">ğŸ¨ Reservas</div>
      <div class="tab-btn"       onclick="switchTab('reception')">ğŸ› Concierge</div>
      <div class="tab-btn"       onclick="switchTab('upselling')">â­ Ofertas</div>
    </div>

    <!-- Chat -->
    <div class="chat-area" id="chatArea"></div>

    <!-- Quick replies -->
    <div class="suggestions-area" id="suggestionsArea"></div>

    <!-- Input bar -->
    <div class="input-bar">
      <button class="ib-emoji">ğŸ˜Š</button>
      <input class="ib-field" id="msgInput" placeholder="Message" autocomplete="off" />
      <button class="ib-attach">ğŸ“</button>
      <button class="ib-send mic" id="sendBtn">ğŸ¤</button>
    </div>

  </div><!-- /phone -->

  <!-- RIGHT: Features -->
  <aside class="side-panel">
    <div class="panel-card">
      <div class="panel-title">Por quÃ© los hoteles eligen Velora</div>
      <div class="panel-sub">Resultados reales, desde el dÃ­a uno</div>

      <div class="feat-item">
        <div class="feat-icon">ğŸ•</div>
        <div class="feat-text">
          <h4>Disponible 24/7</h4>
          <p>RespondÃ© a huÃ©spedes a las 3 AM sin personal extra. Sin perder reservas.</p>
        </div>
      </div>
      <div class="feat-item">
        <div class="feat-icon">ğŸ’¬</div>
        <div class="feat-text">
          <h4>WhatsApp Nativo</h4>
          <p>Funciona donde ya estÃ¡n tus huÃ©spedes. Sin descargar nada.</p>
        </div>
      </div>
      <div class="feat-item">
        <div class="feat-icon">ğŸ’°</div>
        <div class="feat-text">
          <h4>Upselling AutomÃ¡tico</h4>
          <p>Ofertas en el momento perfecto â€” post-reserva, pre-llegada, dÃ­a 1.</p>
        </div>
      </div>
      <div class="feat-item">
        <div class="feat-icon">ğŸ“Š</div>
        <div class="feat-text">
          <h4>Dashboard en Tiempo Real</h4>
          <p>SeguÃ­ cada conversaciÃ³n, revenue generado y satisfacciÃ³n.</p>
        </div>
      </div>
      <div class="feat-item">
        <div class="feat-icon">ğŸ”—</div>
        <div class="feat-text">
          <h4>IntegraciÃ³n con PMS</h4>
          <p>Se conecta a Opera, Cloudbeds y +40 sistemas en 48 horas.</p>
        </div>
      </div>

      <div class="roi-div"></div>
      <button class="cta-btn" onclick="alert('Â¡Gracias por el interÃ©s! Te contactamos pronto.')">Agendar Demo en Vivo â†’</button>
    </div>
  </aside>

</div>

<script>
// â”€â”€ STATE â”€â”€
let tab          = 'reservations';
let isTyping     = false;
let revenue      = 0;
let rooms        = 50;

// Booking state
let reservPhase  = 'gathering';
let booking      = { guests: null, checkIn: null, checkOut: null, nights: 1, room: null, name: null };

// Check-in state
let ciPhase = null; // null | name | doc | dob | nationality | address | arrival | confirm | done
let ciData  = {};

// â”€â”€ HELPERS â”€â”€
function getTime() {
  return new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
}
function scrollDown() {
  const ca = document.getElementById('chatArea');
  setTimeout(() => ca.scrollTop = ca.scrollHeight, 60);
}
function clearChat() {
  document.getElementById('chatArea').innerHTML = '';
  document.getElementById('suggestionsArea').innerHTML = '';
}

function addDateChip(text) {
  const ca = document.getElementById('chatArea');
  const d = document.createElement('div');
  d.className = 'date-chip';
  d.innerHTML = `<span>${text}</span>`;
  ca.appendChild(d); scrollDown();
}

function addMessage(role, html, time) {
  const ca = document.getElementById('chatArea');
  const row = document.createElement('div');
  row.className = 'msg-row ' + role;
  const t = time || getTime();
  const ticks = role === 'user' ? `<span class="bticks">âœ“âœ“</span>` : '';
  const meta  = `<div class="bubble-meta"><span class="btime">${t}</span>${ticks}</div>`;
  row.innerHTML = `<div class="msg-bubble">${html}${meta}</div>`;
  ca.appendChild(row); scrollDown();
}

function showTyping() {
  if (isTyping) return;
  isTyping = true;
  setSubtitle('escribiendoâ€¦');
  const ca = document.getElementById('chatArea');
  const row = document.createElement('div');
  row.id = 'typingRow'; row.className = 'typing-row';
  row.innerHTML = `<div class="typing-bub"><div class="td"></div><div class="td"></div><div class="td"></div></div>`;
  ca.appendChild(row); scrollDown();
}
function hideTyping() {
  isTyping = false;
  setSubtitle('en lÃ­nea');
  const el = document.getElementById('typingRow');
  if (el) el.remove();
}
function setSubtitle(text) {
  document.getElementById('agSub').textContent = text;
}

function setSuggestions(items) {
  const sa = document.getElementById('suggestionsArea');
  sa.innerHTML = '';
  items.forEach(item => {
    const btn = document.createElement('button');
    btn.className = 'sugg-btn';
    btn.textContent = typeof item === 'string' ? item : item.label;
    btn.onclick = () => {
      if (typeof item === 'object' && item.action) item.action();
      else sendMsg(btn.textContent);
    };
    sa.appendChild(btn);
  });
  updateSendBtn();
}
function clearSuggestions() {
  document.getElementById('suggestionsArea').innerHTML = '';
}

function updateSendBtn() {
  const btn   = document.getElementById('sendBtn');
  const input = document.getElementById('msgInput');
  if (input.value.trim().length > 0) {
    btn.textContent = 'â¤';
    btn.classList.remove('mic');
  } else {
    btn.textContent = 'ğŸ¤';
    btn.classList.add('mic');
  }
}

function sendMsg(text) {
  if (isTyping || !text.trim()) return;
  document.getElementById('msgInput').value = '';
  updateSendBtn();
  clearSuggestions();
  addMessage('user', text);
  if (tab === 'reservations') advanceReservations(text);
  else if (tab === 'reception') routeReception(text);
  else handleUpsellingMsg(text);
}

function sendFromInput() {
  const input = document.getElementById('msgInput');
  const text  = input.value.trim();
  if (!text || isTyping) return;
  sendMsg(text);
}

// â”€â”€ TAB SWITCH â”€â”€
function switchTab(newTab) {
  tab = newTab; isTyping = false; revenue = 0;
  reservPhase = 'gathering';
  booking  = { guests: null, checkIn: null, checkOut: null, nights: 1, room: null, name: null };
  ciPhase  = null;
  ciData   = {};
  document.querySelectorAll('.tab-btn').forEach((btn, i) => {
    btn.classList.toggle('active', ['reservations','reception','upselling'][i] === newTab);
  });
  const agents = {
    reservations: ['ğŸ¨', 'Velora â€” Reservas',     'en lÃ­nea'],
    reception:    ['ğŸ›ï¸', 'Velora â€” Concierge',     'en lÃ­nea'],
    upselling:    ['â­', 'Velora â€” Ofertas',        'en lÃ­nea'],
  };
  const [icon, name, sub] = agents[newTab];
  document.getElementById('agIcon').textContent = icon;
  document.getElementById('agName').textContent = name;
  setSubtitle(sub);
  clearChat();
  if (newTab === 'reservations') initReservations();
  else if (newTab === 'reception') initReception();
  else initUpselling();
  setTimeout(() => document.getElementById('msgInput').focus(), 120);
}

// â”€â”€ AGENT 1: RESERVATIONS â”€â”€

// Parse number of guests from free text
function parseGuests(text) {
  const t = text.toLowerCase();
  const words = { one:1, two:2, three:3, four:4, five:5, six:6,
                  uno:1, dos:2, tres:3, cuatro:4, cinco:5, seis:6 };
  let m;
  m = t.match(/(\d+)\s*(person|people|guest|adult|pax|persona|hu[eÃ©]sped)/i);
  if (m) return parseInt(m[1]);
  m = t.match(/for\s+(\d+)/i);
  if (m) return parseInt(m[1]);
  m = t.match(/\b(one|two|three|four|five|six|uno|dos|tres|cuatro|cinco|seis)\b/i);
  if (m) return words[m[1].toLowerCase()];
  if (t.match(/solo|just me|myself|sola|alone/)) return 1;
  m = t.match(/\b([1-9])\b/);
  if (m) return parseInt(m[1]);
  return null;
}

// Parse dates from free text, returns { checkIn, checkOut, nights } or null
function parseDates(text) {
  const t = text.toLowerCase().replace(/(\d+)(st|nd|rd|th)/gi, '$1'); // strip ordinals: 3rdâ†’3
  const base = new Date(2026, 1, 21);
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const MONS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  function fmt(d) { return `${DAYS[d.getDay()]} ${d.getDate()} ${MONS[d.getMonth()]}`; }
  function addDays(d, n) { const r = new Date(d); r.setDate(d.getDate() + n); return r; }
  function nextWeekday(wd) { const diff = (wd - base.getDay() + 7) % 7 || 7; return addDays(base, diff); }

  const MONTH_MAP = {
    jan:0, feb:1, mar:2, apr:3, may:4, jun:5, jul:6, aug:7, sep:8, oct:9, nov:10, dec:11,
    january:0, february:1, march:2, april:3, june:5, july:6, august:7,
    september:8, october:9, november:10, december:11,
    enero:0, febrero:1, marzo:2, abril:3, mayo:4, junio:5, julio:6, agosto:7,
    septiembre:8, octubre:9, noviembre:10, diciembre:11
  };

  // Parse a single date string like "3 march", "march 3", "3 de marzo"
  function parseOne(str) {
    const s = str.trim().replace(/(\d+)(st|nd|rd|th)/gi, '$1');
    let m;
    // "3 march" or "march 3" or "3 de marzo"
    m = s.match(/(\d{1,2})\s*(?:de\s*)?([a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)/i) ||
        s.match(/([a-zÃ¡Ã©Ã­Ã³ÃºÃ±]+)\s+(\d{1,2})/i);
    if (m) {
      const word = (m[2] || m[1] || '').toLowerCase();
      const day  = parseInt(m[1]) || parseInt(m[2]);
      // find month key by prefix match
      const key = Object.keys(MONTH_MAP).find(k => word.startsWith(k) || k.startsWith(word.slice(0,3)));
      if (key && day >= 1 && day <= 31) return new Date(2026, MONTH_MAP[key], day);
    }
    return null;
  }

  let ci = null, co = null, nights = 1;

  // â”€â”€ Range first: "3 march to 7 march", "march 3 - march 7", "del 3 al 7 de marzo"
  const rangeRe = /(.+?)\s+(?:to|al|hasta|[-â€“])\s+(.+)/;
  const range = t.match(rangeRe);
  if (range) {
    const a = parseOne(range[1]);
    const b = parseOne(range[2]);
    if (a && b && b > a) {
      nights = Math.round((b - a) / 86400000);
      return { checkIn: fmt(a), checkOut: fmt(b), nights };
    }
  }

  // â”€â”€ Single date keywords
  if      (t.match(/today|hoy/))                       ci = new Date(base);
  else if (t.match(/tomorrow|ma[nÃ±]ana/))              ci = addDays(base, 1);
  else if (t.match(/this\s+weekend|este\s+fin/))       ci = addDays(base, 1);
  else if (t.match(/next\s+weekend|pr[oÃ³]ximo\s+fin/)) ci = addDays(base, 7);
  else if (t.match(/friday|viernes/))                  ci = nextWeekday(5);
  else if (t.match(/saturday|s[aÃ¡]bado/))              ci = nextWeekday(6);
  else if (t.match(/sunday|domingo/))                  ci = nextWeekday(0);
  else if (t.match(/monday|lunes/))                    ci = nextWeekday(1);
  else if (t.match(/tuesday|martes/))                  ci = nextWeekday(2);
  else if (t.match(/wednesday|mi[eÃ©]rcoles/))          ci = nextWeekday(3);
  else if (t.match(/thursday|jueves/))                 ci = nextWeekday(4);
  else if (t.match(/next\s+week|pr[oÃ³]xima\s+semana/)) ci = addDays(base, 7);
  else                                                  ci = parseOne(t);

  if (!ci) return null;

  // â”€â”€ Duration
  const nm = t.match(/(\d+)\s*night/i);
  if      (nm)                            nights = parseInt(nm[1]);
  else if (t.match(/weekend|fin de semana/)) nights = 2;
  else if (t.match(/\bweek\b|semana/))   nights = 7;

  return { checkIn: fmt(ci), checkOut: fmt(addDays(ci, nights)), nights };
}

// Parse which room type the user wants
function parseRoomChoice(text) {
  const t = text.toLowerCase();
  if (t.match(/standard|est[aÃ¡]ndar|basic|cheap|m[aÃ¡]s barato|120|first|primero/))       return 'standard';
  if (t.match(/deluxe|superior|king|minibar|vista ciudad|second|segundo|200/))             return 'deluxe';
  if (t.match(/suite|luxury|jacuzzi|terraza|best|mejor|vip|350|third|tercero/))            return 'suite';
  return null;
}

// Room catalogue
const ROOMS = [
  { key:'standard', icon:'ğŸ›', name:'Standard',  price:120,  view:'Cama doble',     tags:['ğŸ› Cama doble','ğŸš¿ BaÃ±o privado','ğŸ“º TV','ğŸ“¶ WiFi'],   avail:4 },
  { key:'deluxe',   icon:'âœ¨', name:'Deluxe',    price:200,  view:'Vista ciudad',   tags:['ğŸ‘‘ King','ğŸ· Minibar','ğŸŒ† Vista ciudad'],               avail:2 },
  { key:'suite',    icon:'ğŸ‘‘', name:'Suite',      price:350,  view:'Terraza privada',tags:['ğŸ› Jacuzzi','ğŸŒ… Terraza','â­ VIP'],                    avail:1 },
];

function initReservations() {
  reservPhase = 'gathering';
  booking     = { guests:null, checkIn:null, checkOut:null, nights:1, room:null, name:null };
  addDateChip('Today Â· Sat, 21 Feb 2026');
  setTimeout(() => {
    addMessage('agent',
      `Hola! Bienvenido/a a <strong>Hotel Palermo Soho</strong> ğŸ¨<br>Soy Velora, tu asistente de reservas.<br><br>Contame â€” <strong>cuÃ¡ndo</strong> querÃ©s hospedarte y <strong>cuÃ¡ntos huÃ©spedes</strong> serÃ­an?`,
      '9:41');
    setSuggestions([
      '2 personas, este viernes',
      '3 huÃ©spedes prÃ³ximo finde',
      'Solo yo, maÃ±ana',
    ]);
  }, 350);
}

function advanceReservations(text) {
  if (reservPhase === 'gathering') {
    const t = text.toLowerCase();
    const g = parseGuests(text);
    const d = parseDates(text);
    if (g) booking.guests = g;
    if (d) { booking.checkIn = d.checkIn; booking.checkOut = d.checkOut; booking.nights = d.nights; }

    // User asking about rooms/prices without booking info â†’ show catalogue
    if (!g && !d && t.match(/room|habitaci[oÃ³]n|precio|price|rate|tarifa|available|disponib|option|what do you have|cuanto|how much|cuÃ¡nto/i)) {
      showTyping();
      return setTimeout(() => {
        hideTyping();
        addMessage('agent', `Por supuesto! Estos son nuestros tipos de habitaciÃ³n en <strong>Hotel Palermo Soho</strong>:<div class="room-opts">
          <div class="room-opt">
            <div class="room-opt-h"><span class="rn">ğŸ› Standard</span><span class="rp">$120/noche</span></div>
            <div class="room-opt-b"><span class="rtag">ğŸ› Cama doble</span><span class="rtag">ğŸš¿ BaÃ±o privado</span><span class="rtag">ğŸ“º TV</span></div>
          </div>
          <div class="room-opt">
            <div class="room-opt-h"><span class="rn">âœ¨ Deluxe</span><span class="rp">$200/noche</span></div>
            <div class="room-opt-b"><span class="rtag">ğŸ‘‘ King</span><span class="rtag">ğŸ· Minibar</span><span class="rtag">ğŸŒ† Vista ciudad</span></div>
          </div>
          <div class="room-opt">
            <div class="room-opt-h"><span class="rn">ğŸ‘‘ Suite</span><span class="rp">$350/noche</span></div>
            <div class="room-opt-b"><span class="rtag">ğŸ› Jacuzzi</span><span class="rtag">ğŸŒ… Terraza</span><span class="rtag">â­ VIP</span></div>
          </div>
        </div>Todas incluyen WiFi gratis, limpieza diaria y acceso a la pileta rooftop ğŸŠ<br><br>Para ver <strong>disponibilidad en tiempo real</strong>, decime tus fechas y cantidad de huÃ©spedes!`);
        setSuggestions(['2 personas, este viernes', '3 huÃ©spedes prÃ³ximo finde', '1 persona, 5â€“7 marzo']);
      }, 1000);
    }

    if (booking.guests && booking.checkIn) {
      showAvailability();
    } else if (!booking.guests && !booking.checkIn) {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('agent', `Con gusto te ayudo! ğŸ˜Š Para verificar disponibilidad necesito dos datos:<br><br>ğŸ“… <strong>Fechas</strong> â€” ej: "este viernes", "5 al 7 de marzo"<br>ğŸ‘¥ <strong>HuÃ©spedes</strong> â€” ej: "2 personas", "3 huÃ©spedes"<br><br>PodÃ©s mandarme todo junto, como: <em>"2 personas, 5 al 7 de marzo"</em>`);
        setSuggestions(['2 personas este viernes', '3 huÃ©spedes prÃ³ximo finde', 'QuÃ© habitaciones tienen?']);
      }, 900);
    } else if (!booking.guests) {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('agent', `Perfecto â€” <strong>${booking.checkIn} â†’ ${booking.checkOut}</strong>! ğŸ“…<br><br>Solo me falta un dato: <strong>cuÃ¡ntos huÃ©spedes</strong> serÃ­an?`);
        setSuggestions(['1 persona', '2 personas', '3 personas', '4 personas']);
      }, 900);
    } else {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('agent', `Genial, <strong>${booking.guests} huÃ©sped${booking.guests>1?'es':''}</strong>! ğŸ‘¥<br><br>Ahora necesito las <strong>fechas</strong>. ProbÃ¡ algo como:<br><span style="color:#666666;font-size:12.5px">â€¢ "este viernes"<br>â€¢ "5 al 7 de marzo"<br>â€¢ "prÃ³ximo fin de semana"<br>â€¢ "del 3 al 7 de marzo"</span>`);
        setSuggestions(['Este viernes','PrÃ³ximo finde','5 al 7 de marzo']);
      }, 900);
    }

  } else if (reservPhase === 'selecting') {
    const choice = parseRoomChoice(text);
    if (choice) {
      selectRoom(choice);
    } else {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('agent', `No captÃ© quÃ© habitaciÃ³n te gustarÃ­a ğŸ˜Š ElegÃ­ una de estas:<br><br>ğŸ› <strong>Standard</strong> â€” $${120*booking.nights} total<br>âœ¨ <strong>Deluxe</strong> â€” $${200*booking.nights} total<br>ğŸ‘‘ <strong>Suite</strong> â€” $${350*booking.nights} total<br><br>EscribÃ­ el nombre o tocÃ¡ un botÃ³n!`);
        setSuggestions([
          { label:`ğŸ› Standard â€” $${120*booking.nights}`,  action:()=>{ addMessage('user','Standard por favor'); clearSuggestions(); selectRoom('standard'); }},
          { label:`âœ¨ Deluxe â€” $${200*booking.nights}`,    action:()=>{ addMessage('user','Deluxe por favor'); clearSuggestions(); selectRoom('deluxe'); }},
          { label:`ğŸ‘‘ Suite â€” $${350*booking.nights}`,     action:()=>{ addMessage('user','Suite por favor'); clearSuggestions(); selectRoom('suite'); }},
        ]);
      }, 800);
    }

  } else if (reservPhase === 'naming') {
    // Accept anything that looks like a name (> 3 chars, not a command)
    const name = text.trim();
    if (name.length >= 3 && !name.match(/^(yes|no|ok|si|sÃ­)$/i)) {
      booking.name = name;
      confirmBooking();
    } else {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('agent', `Â¿PodrÃ­as compartirme tu <strong>nombre completo</strong> para completar la reserva?`);
      }, 800);
    }

  } else { // done â€” answer follow-up questions
    const t = text.toLowerCase();
    let reply = `Por supuesto! Para cualquier otra consulta escribinos cuando quieras. Â¡Te esperamos, ${booking.name || ''}! ğŸ˜Š`;
    if (t.match(/early|check.?in|arrive|llegada/))
      reply = `AgreguÃ© un pedido de early check-in a tu reserva âœ… El costo es $20 USD (sujeto a disponibilidad). Te avisamos por WhatsApp cuando estÃ© lista la habitaciÃ³n!`;
    else if (t.match(/wifi|internet|password|contraseÃ±a/))
      reply = `ğŸ“¶ <strong>WiFi:</strong> Red <strong>PalermSoho-Guest</strong> Â· Clave <strong>palermo2024</strong><br>Disponible en todas las habitaciones y Ã¡reas comunes. Â¿Algo mÃ¡s?`;
    else if (t.match(/breakfast|desayun|food|comer/))
      reply = `ğŸ³ Desayuno en <strong>Restaurant Nivel 1</strong>:<br>Todos los dÃ­as <strong>07:00 â€“ 11:00</strong><br>Buffet completo incluido. Â¡Que lo disfrutes!`;
    else if (t.match(/pool|piscina|pileta|spa|gym/))
      reply = `ğŸŠ Pileta Rooftop: <strong>08:00â€“20:00</strong> Â· Spa: <strong>10:00â€“20:00</strong> (cargo extra) Â· Gym: 24/7.`;
    else if (t.match(/park|valet|coche|car|estacion/))
      reply = `ğŸš— Estacionamiento: <strong>$15/dÃ­a</strong>. Plazas limitadas, consultÃ¡ disponibilidad en recepciÃ³n.`;
    else if (t.match(/cancel|cambiar|change|modify/))
      reply = `Sin problema! CancelaciÃ³n <strong>gratuita hasta 48h antes</strong> del arribo. Â¿QuerÃ©s modificar fechas, tipo de habitaciÃ³n o cancelar?`;
    showTyping();
    setTimeout(() => { hideTyping(); addMessage('agent', reply); }, 1100);
  }
}

function showAvailability() {
  reservPhase = 'selecting';
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMessage('agent', `Verificando disponibilidad para <strong>${booking.guests} huÃ©sped${booking.guests>1?'es':''}</strong> Â· <strong>${booking.checkIn} â†’ ${booking.checkOut}</strong> (${booking.nights} noche${booking.nights>1?'s':''})â€¦`);
    showTyping();
    setTimeout(() => {
      hideTyping();
      let cards = '';
      ROOMS.forEach(r => {
        const total = r.price * booking.nights;
        cards += `
          <div class="room-opt" style="cursor:pointer" onclick="selectRoom('${r.key}')">
            <div class="room-opt-h">
              <span class="rn">${r.icon} ${r.name}</span>
              <span class="rp">$${r.price}/night</span>
            </div>
            <div class="room-opt-b">
              ${r.tags.map(t=>`<span class="rtag">${t}</span>`).join('')}
              <span class="rtag" style="background:#e8f5e9;color:#2e7d32">âœ“ ${r.avail} disponible${r.avail>1?'s':''}</span>
            </div>
            <div style="padding:3px 10px 7px;font-size:11.5px;color:#666666">
              ${booking.nights} noche${booking.nights>1?'s':''}: <strong style="color:#111">$${total} total</strong> Â· TocÃ¡ para reservar
            </div>
          </div>`;
      });
      addMessage('agent', `âœ… <strong>3 tipos de habitaciÃ³n disponibles</strong> para tus fechas! TocÃ¡ una para reservar:<div class="room-opts">${cards}</div>`);
      setSuggestions([
        { label:`ğŸ› Standard â€” $${120*booking.nights}`,  action:()=>{ addMessage('user','Standard por favor'); clearSuggestions(); selectRoom('standard'); }},
        { label:`âœ¨ Deluxe â€” $${200*booking.nights}`,    action:()=>{ addMessage('user','Deluxe por favor'); clearSuggestions(); selectRoom('deluxe'); }},
        { label:`ğŸ‘‘ Suite â€” $${350*booking.nights}`,     action:()=>{ addMessage('user','Suite por favor'); clearSuggestions(); selectRoom('suite'); }},
      ]);
    }, 1800);
  }, 900);
}

function selectRoom(key) {
  clearSuggestions();
  const r = ROOMS.find(x => x.key === key);
  booking.room = r;
  reservPhase = 'naming';
  const total = r.price * booking.nights;
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMessage('agent', `${r.icon} <strong>${r.name}</strong> â€” ${r.view}<br><br>
      ğŸ“… ${booking.checkIn} â†’ ${booking.checkOut}<br>
      ğŸ‘¥ ${booking.guests} huÃ©sped${booking.guests>1?'es':''} Â· ${booking.nights} noche${booking.nights>1?'s':''}<br>
      ğŸ’° <strong>$${total} total</strong><br><br>
      Para confirmar la reserva, Â¿cuÃ¡l es tu <strong>nombre completo</strong>?`);
    setSuggestions(['Juan PÃ©rez','MarÃ­a GarcÃ­a','Carlos LÃ³pez']);
  }, 1200);
}

function confirmBooking() {
  clearSuggestions();
  reservPhase = 'done';
  showTyping();
  setTimeout(() => {
    hideTyping();
    const num   = 'PLR-' + (1000 + Math.floor(Math.random() * 8999)) + '-' + (100 + Math.floor(Math.random() * 899));
    const total = booking.room.price * booking.nights;
    addMessage('agent', `
      <div class="conf-card">
        <div class="conf-title">âœ… Reserva Confirmada!</div>
        <div class="conf-row"><span>HuÃ©sped</span><strong>${booking.name}</strong></div>
        <div class="conf-row"><span>HabitaciÃ³n</span><span>${booking.room.name} â€” ${booking.room.view}</span></div>
        <div class="conf-row"><span>Check-in</span><span>${booking.checkIn} Â· 15:00</span></div>
        <div class="conf-row"><span>Check-out</span><span>${booking.checkOut} Â· 11:00</span></div>
        <div class="conf-row"><span>HuÃ©spedes</span><span>${booking.guests}</span></div>
        <div class="conf-row"><span>Total</span><strong>$${total}</strong></div>
        <div class="conf-num">${num}</div>
      </div>`);
    setTimeout(() => {
      addMessage('agent', `ğŸ“§ Te estamos enviando un email de confirmaciÃ³n con:<br>â€¢ Detalles de la reserva y recibo<br>â€¢ DirecciÃ³n: <strong>Honduras 4742, Palermo Soho, Buenos Aires</strong><br>â€¢ TelÃ©fono: <strong>+54 11 4833-1234</strong><br>â€¢ CancelaciÃ³n gratuita hasta 48h antes`);
      setTimeout(() => {
        addMessage('agent', `ğŸ’¡ <strong>Â¡AhorrÃ¡ tiempo al llegar!</strong> PodÃ©s completar tu <strong>check-in online</strong> acÃ¡ mismo por WhatsApp antes de llegar â€” sin cola en recepciÃ³n, directo a tu habitaciÃ³n ğŸ”‘<br><br>Â¿QuerÃ©s hacerlo ahora?`);
        setSuggestions([
          { label: 'SÃ­, hacer check-in âœ…', action: () => { addMessage('user','SÃ­, quiero hacer el check-in'); clearSuggestions(); switchTab('reception'); setTimeout(startCheckIn, 600); }},
          'Lo hago despuÃ©s',
        ]);
      }, 1200);
    }, 900);
    setSuggestions(['Â¿Puedo pedir early check-in?','Â¿Horarios de pileta?']);
  }, 2000);
}

// â”€â”€ AGENT 2: RECEPTION â”€â”€

const CONCIERGE = {
  wifi: {
    match: /wifi|wi-fi|internet|password|contraseÃ±a|red|network|connect|clave/i,
    reply: `ğŸ“¶ <strong>WiFi</strong><br><br>Red: <strong>PalermSoho-Guest</strong><br>Clave: <strong>palermo2024</strong><br><br>Disponible en todas las habitaciones y Ã¡reas comunes. Â¿TenÃ©s algÃºn problema? LlamÃ¡ a recepciÃ³n al <strong>0</strong> â€” te ayudamos al toque.`,
    follow: ['Horario de pileta?', 'Horario de desayuno?']
  },
  breakfast: {
    match: /breakfast|desayun|buffet|eat|morning|maÃ±ana|comer|food|cafÃ©|coffee/i,
    reply: `ğŸ³ <strong>Desayuno â€” Restaurant Nivel 1</strong><br><br>ğŸ•– Todos los dÃ­as: <strong>07:00 â€“ 11:00</strong><br><br>Buffet completo con opciones calientes y frÃ­as, estaciÃ³n de huevos, medialunas artesanales y jugos naturales â˜€ï¸<br><br><em>Room service de desayuno disponible hasta las 12:00</em>`,
    follow: ['Clave de WiFi?', 'MenÃº de room service?']
  },
  pool: {
    match: /pool|piscina|pileta|spa|jacuzzi|gym|fitness|sauna|steam|nadar|swim/i,
    reply: `ğŸŠ <strong>Pileta y Wellness</strong><br><br>ğŸŠ Pileta Rooftop: <strong>08:00 â€“ 20:00</strong><br>ğŸ§– Spa: <strong>10:00 â€“ 20:00</strong> (cargo extra)<br>ğŸ‹ï¸ Gym: <strong>24/7</strong><br><br>Toallas disponibles en el deck. Tratamientos de spa con reserva previa â€” consultÃ¡ en recepciÃ³n.`,
    follow: ['Reservar un spa', 'Horario de desayuno?']
  },
  parking: {
    match: /park|valet|car|coche|auto|garaje|vehicle|estacion/i,
    reply: `ğŸš— <strong>Estacionamiento</strong><br><br>ğŸ…¿ï¸ <strong>$15/dÃ­a</strong> â€” plazas limitadas<br><br>ConsultÃ¡ disponibilidad en recepciÃ³n. Acceso las 24hs.`,
    follow: ['Clave de WiFi?', 'Hora de check-out?']
  },
  checkout: {
    match: /check.?out|checkout|salida|leave|exit|late check|hora de salida/i,
    reply: `ğŸ <strong>Check-out</strong><br><br>ğŸ•› Check-out estÃ¡ndar: <strong>11:00</strong><br>ğŸ• Late checkout: <strong>$30</strong> (sujeto a disponibilidad)<br><br>La factura se envÃ­a por email automÃ¡ticamente. Â¿QuerÃ©s solicitar late checkout?`,
    follow: ['SÃ­, pedir late checkout', 'No, estÃ¡ bien asÃ­']
  },
  roomservice: {
    match: /room service|roomservice|order|food|dinner|lunch|cena|almuerzo|pedir|hambre|hungry|eat/i,
    reply: `ğŸ½ <strong>Room Service</strong><br><br>Disponible: <strong>07:00 â€“ 23:00</strong><br><br>ğŸ“± PedÃ­ desde la tablet de la habitaciÃ³n (~15 min)<br>ğŸ“ LlamÃ¡ a recepciÃ³n desde tu habitaciÃ³n (~20 min)<br><br>ğŸŒŸ MenÃº completo disponible en la tablet de la habitaciÃ³n<br>ğŸ¥— Opciones veganas y sin TACC disponibles`,
    follow: ['MenÃº completo?', 'WiFi para la tablet?']
  },
  taxi: {
    match: /taxi|uber|cab|transport|airport|aeropuerto|transfer|ride|llevar|remis/i,
    reply: `ğŸš• <strong>Transporte</strong><br><br>Podemos organizar:<br>ğŸ›« Transfer desde Ezeiza: <strong>$35 USD</strong> (taxi) / <strong>$40 USD</strong> (transfer privado)<br>ğŸ›« Transfer desde Aeroparque: <strong>$15 USD</strong> (taxi)<br><br>Decime tu destino y horario â€” lo coordinamos para vos ğŸ™Œ`,
    follow: ['Reservar transfer', 'Taxi para esta noche']
  },
  towels: {
    match: /towel|toalla|amenities|shampoo|soap|jabÃ³n|pillow|almohada|blanket|manta|iron|plancha/i,
    reply: `ğŸ› <strong>Pedido a Housekeeping</strong><br><br>Ya estoy enviando tu pedido a housekeeping. Entrega estimada: <strong>15â€“20 minutos</strong>.<br><br>TambiÃ©n podÃ©s llamar a recepciÃ³n al <strong>0</strong> para asistencia inmediata. Â¿NecesitÃ¡s algo mÃ¡s?`,
    follow: ['Almohadas extra tambiÃ©n', 'Eso es todo, gracias!']
  },
  laundry: {
    match: /laundry|lavanderÃ­a|lavanderia|wash|dry clean|ropa|clothes|lavar/i,
    reply: `ğŸ‘” <strong>Servicio de LavanderÃ­a</strong><br><br>ğŸ•— Servicio del dÃ­a: dejÃ¡ antes de las <strong>09:00</strong>, listo a las 18:00<br>âš¡ Express (4h): +50% de recargo<br>ğŸ§º Dry cleaning disponible<br><br>DejÃ¡ la bolsa de lavanderÃ­a (en el placard) fuera de tu puerta o llamÃ¡ a recepciÃ³n.`,
    follow: ['CuÃ¡nto sale?', 'Gracias!']
  },
  wakeup: {
    match: /wake.?up|alarm|despertar|llamada|morning call/i,
    reply: `â° <strong>Llamada de Despertador</strong><br><br>Â¡Sin problema! Confirmame la hora que querÃ©s â€” me aseguro de que no te la pierdas ğŸ˜Š<br><br>TambiÃ©n podÃ©s configurarlo desde el telÃ©fono de la habitaciÃ³n.`,
    follow: ['6:00 AM por favor', '7:30 AM']
  },
  complaint: {
    match: /problem|issue|broken|not working|complaint|queja|problema|roto|noise|ruido|cold|calor|hot|ac|heat|temperatura/i,
    reply: `ğŸ™ Lamento mucho escuchar eso â€” esa no es la experiencia que queremos para vos!<br><br>Ya estoy escalando esto a nuestro equipo de mantenimiento <strong>como prioridad</strong>. Alguien va a estar en tu habitaciÃ³n en <strong>15 minutos</strong>.<br><br>Como disculpa, te sumamos un <strong>crÃ©dito de bebida gratis</strong> a tu cuenta. ğŸ¹ Â¿Hay algo mÃ¡s en que pueda ayudarte?`,
    follow: ['Gracias!', 'TambiÃ©n traigan toallas extra']
  },
  restaurant: {
    match: /restaurant|dinner|reserv|table|mesa|tonight|esta noche|eat out|cena|donde comer|restaurante/i,
    reply: `ğŸ½ <strong>Restaurantes Recomendados en Palermo</strong><br><br>Nuestro concierge recomienda:<br><br>â­ <strong>Don Julio</strong> â€” Parrilla de autor, 10 min caminando<br>â­ <strong>Proper</strong> â€” Cocina contemporÃ¡nea en Plaza Serrano, 2 cuadras<br>â­ <strong>Osaka</strong> â€” Nikkei, 5 min en taxi<br><br>Â¿QuerÃ©s que te haga una reserva? Decime horario y cantidad de personas ğŸ˜Š`,
    follow: ['Reservar Don Julio para 2 a las 21hs', 'QuÃ© mÃ¡s hay cerca?']
  },
  checkin: {
    match: /check.?in|checkin|arrive|llegada|when can|room ready|llego/i,
    reply: `ğŸ”‘ <strong>InformaciÃ³n de Check-in</strong><br><br>Check-in estÃ¡ndar: <strong>15:00</strong><br><br>ğŸ“± RecibÃ­s tu <strong>llave digital</strong> por WhatsApp â€” sin pasar por recepciÃ³n<br>ğŸŒ… Early check-in: disponible desde las <strong>12:00</strong> ($20 USD, sujeto a disponibilidad)<br><br>Â¿QuerÃ©s que solicite early check-in para tu llegada?`,
    follow: ['SÃ­, pedir early check-in', 'No, 15:00 estÃ¡ bien']
  },
  spa: {
    match: /spa|massage|masaje|treatment|facial|manicure|pedicure|beauty/i,
    reply: `ğŸ’† <strong>Spa & Wellness</strong><br><br>Abierto todos los dÃ­as <strong>10:00 â€“ 20:00</strong><br><br>Tratamientos populares:<br>ğŸ’† Masaje Relajante (60 min) â€” <strong>$50</strong><br>ğŸ’† Masaje Descontracturante (90 min) â€” <strong>$135</strong><br>âœ¨ Facial Signature (60 min) â€” <strong>$85</strong><br><br>Â¿QuerÃ©s reservar un tratamiento? Decime el servicio y tu horario preferido ğŸ™Œ`,
    follow: ['Reservar un masaje para maÃ±ana', 'QuÃ© otros tratamientos tienen?']
  },
};

function initReception() {
  addDateChip('Pre-arrival Â· Jue, 20 Feb');
  setTimeout(() => {
    addMessage('agent',
      `ğŸŒŸ Â¡Buenas tardes! Soy Velora de <strong>Hotel Palermo Soho</strong>.<br><br>Tu check-in es <strong>maÃ±ana a las 15:00</strong>. Â¡Te esperamos con todo!`, '20:30');
    setTimeout(() => {
      addMessage('agent',
        `AcÃ¡ te dejo un adelanto de lo que te espera:<br><br>
         ğŸ”‘ Llave digital por WhatsApp antes de llegar<br>
         ğŸš— Estacionamiento disponible ($15/dÃ­a)<br>
         ğŸŠ Pileta rooftop abierta hasta las 20:00<br>
         ğŸ³ Desayuno desde las 07:00 en Restaurant Nivel 1<br><br>
         Escribime lo que necesites â€” soy tu concierge 24/7 ğŸ˜Š`);
      setSuggestions([
        'Hacer mi check-in online',
        'Clave de WiFi?',
        'Room service?',
        'Necesito un taxi',
      ]);
    }, 800);
  }, 300);
}

function routeReception(text) {
  if (isTyping) return;

  // â”€â”€ If check-in flow is active, always route there
  if (ciPhase && ciPhase !== 'done') {
    return handleCheckIn(text);
  }

  // â”€â”€ Trigger check-in flow
  if (/check.?in|checkin|online check|auto check|registro|hacer el check|quiero registrar|self check/i.test(text)) {
    return startCheckIn();
  }

  // Match against all intents
  for (const [key, intent] of Object.entries(CONCIERGE)) {
    if (intent.match.test(text)) {
      return replyWithIntent(intent);
    }
  }
  // Late check-out confirmation
  if (text.toLowerCase().match(/yes.*late|late.*yes|sÃ­.*tarde|request.*late|pedir.*late/i)) {
    showTyping();
    return setTimeout(() => {
      hideTyping();
      addMessage('agent', `âœ… Late checkout confirmado! Se agrega un cargo de <strong>$30</strong> a tu cuenta (sujeto a disponibilidad). DisfrutÃ¡ una maÃ±ana relajada ğŸŒ…`);
      clearSuggestions();
    }, 1200);
  }
  // Wake-up time confirmation
  const timeMatch = text.match(/(\d{1,2})[:\.]?(\d{0,2})\s*(am|pm|AM|PM)?/);
  if (timeMatch && text.toLowerCase().match(/am|pm|:[0-5]\d|\b[6-9]\b|\b1[0-2]\b/)) {
    showTyping();
    return setTimeout(() => {
      hideTyping();
      addMessage('agent', `â° Llamada de despertador programada para las <strong>${text.trim()}</strong> â€” Â¡listo! Â¿NecesitÃ¡s algo mÃ¡s? ğŸ˜Š`);
      clearSuggestions();
    }, 1000);
  }
  // Positive/done responses
  if (text.toLowerCase().match(/^(no|no thanks|that's all|gracias|thank|perfect|great|ok|ğŸ‘)$/i)) {
    showTyping();
    return setTimeout(() => {
      hideTyping();
      addMessage('agent', `Â¡Perfecto! Que tengas una estadÃ­a increÃ­ble ğŸŒŸ RecordÃ¡ que estoy disponible 24/7 â€” escribime cuando necesites!`);
      clearSuggestions();
    }, 900);
  }
  // Generic fallback â€” still helpful
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMessage('agent', `Â¡Entendido! Ya estoy pasando tu pedido a nuestro equipo ğŸ™Œ EsperÃ¡ una respuesta en unos minutos.<br><br>Â¿Hay algo mÃ¡s en que pueda ayudarte?`);
    setSuggestions([
      'Clave de WiFi?',
      'Horario de pileta?',
      'Room service',
      'Necesito un taxi',
    ]);
  }, 1300);
}

// â”€â”€ AUTO CHECK-IN FLOW â”€â”€
const CI_STEPS = {
  reservation: { label: 'Nro. Reserva', q: `Primero, tu <strong>nÃºmero de reserva</strong>.<br><span style="color:rgba(255,255,255,.6);font-size:12px">ej: "PLR-1234-567" â€” lo encontrÃ¡s en tu confirmaciÃ³n</span>`, hint: null },
  name:        { label: 'Nombre',           q: `Tu <strong>nombre completo</strong> tal como aparece en tu documento?`, hint: null },
  doc:         { label: 'Documento',         q: `Tu <strong>documento de identidad</strong>:<br>EscribÃ­ el tipo y nÃºmero.<br><span style="color:rgba(255,255,255,.6);font-size:12px">ej: "Pasaporte AB123456" Â· "DNI 12345678"</span>`, hint: null },
  dob:         { label: 'Fecha Nac.',       q: `Tu <strong>fecha de nacimiento</strong>? (DD/MM/AAAA)<br><span style="color:rgba(255,255,255,.6);font-size:12px">ej: "15/03/1990"</span>`, hint: null },
  nationality: { label: 'Nacionalidad',         q: `Tu <strong>nacionalidad</strong>?<br><span style="color:rgba(255,255,255,.6);font-size:12px">ej: "Argentina", "EspaÃ±ola", "Americana"</span>`, hint: ['Argentina','EspaÃ±ola','Mexicana','Americana','BrasileÃ±a'] },
  address:     { label: 'DirecciÃ³n',        q: `Tu <strong>direcciÃ³n</strong>?<br><span style="color:rgba(255,255,255,.6);font-size:12px">Calle, nÃºmero, ciudad y paÃ­s<br>ej: "Av. Corrientes 1234, Buenos Aires, Argentina"</span>`, hint: null },
  arrival:     { label: 'Hora de Llegada',   q: `Â¿A quÃ© hora estimÃ¡s <strong>llegar al hotel</strong>?<br><span style="color:rgba(255,255,255,.6);font-size:12px">ej: "15:00", "alrededor de las 16:00", "despuÃ©s de las 18:00"</span>`, hint: ['Antes de las 15:00','Entre 15:00â€“16:00','DespuÃ©s de las 18:00','Noche (despuÃ©s de 22:00)'] },
};

const CI_ORDER = ['reservation','name','doc','dob','nationality','address','arrival'];

function progressBar(step) {
  const idx = CI_ORDER.indexOf(step);
  const pct = Math.round(((idx + 1) / (CI_ORDER.length + 1)) * 100);
  return `<div class="ci-progress"><div class="ci-progress-fill" style="width:${pct}%"></div></div>
          <div style="font-size:10px;color:rgba(255,255,255,.5);margin-bottom:8px">Step ${idx+1} of ${CI_ORDER.length}</div>`;
}

function startCheckIn() {
  ciPhase = 'reservation';
  ciData  = {};
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMessage('agent', `âœ… <strong>Check-in Online</strong><br><br>Â¡Perfecto! Te guÃ­o en el proceso â€” son solo <strong>2 minutos</strong> y al final recibÃ­s tu llave digital ğŸ”‘<br><br>Necesito algunos datos para el registro del hotel. Â¡Empecemos!`);
    setTimeout(() => {
      addMessage('agent', `<div class="ci-card" style="background:linear-gradient(135deg,#4401ff,#6630ff)">${progressBar('reservation')}<div style="font-size:13px">${CI_STEPS.reservation.q}</div></div>`);
    }, 700);
  }, 1000);
}

function handleCheckIn(text) {
  if (ciPhase === 'confirm') {
    const t = text.toLowerCase();
    if (t.match(/yes|confirm|correct|sÃ­|si|ok|confirmar|todo bien|correcto/i)) {
      completeCheckIn();
    } else if (t.match(/no|change|wrong|cambiar|incorrecto/i)) {
      ciPhase = null;
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('agent', `Â¡Sin problema! Empecemos de nuevo. Â¿QuÃ© dato querÃ©s corregir?`);
        setSuggestions(CI_ORDER.map(k => `Corregir ${CI_STEPS[k].label}`));
      }, 800);
    } else {
      completeCheckIn(); // assume yes
    }
    return;
  }

  // Validate & save current field
  const val = text.trim();
  if (val.length < 2) {
    showTyping();
    return setTimeout(() => {
      hideTyping();
      addMessage('agent', `No captÃ© eso ğŸ˜Š ${CI_STEPS[ciPhase].q}`);
    }, 700);
  }

  // Save value
  ciData[ciPhase] = val;
  clearSuggestions();

  // Advance to next step
  const idx  = CI_ORDER.indexOf(ciPhase);
  const next = CI_ORDER[idx + 1];

  if (!next) {
    // All data collected â†’ show summary
    ciPhase = 'confirm';
    showTyping();
    setTimeout(() => {
      hideTyping();
      addMessage('agent', `Â¡Casi listo! RevisÃ¡ tu informaciÃ³n:<div class="ci-card">
        <div class="ci-card-title">ğŸ“‹ Resumen de Check-in</div>
        <div class="ci-row"><span>Reserva</span><span>${ciData.reservation}</span></div>
        <div class="ci-row"><span>Nombre</span><span>${ciData.name}</span></div>
        <div class="ci-row"><span>Documento</span><span>${ciData.doc}</span></div>
        <div class="ci-row"><span>Fecha Nac.</span><span>${ciData.dob}</span></div>
        <div class="ci-row"><span>Nacionalidad</span><span>${ciData.nationality}</span></div>
        <div class="ci-row"><span>DirecciÃ³n</span><span>${ciData.address}</span></div>
        <div class="ci-row"><span>Llegada</span><span>${ciData.arrival}</span></div>
      </div>Â¿EstÃ¡ todo correcto?`);
      setSuggestions(['SÃ­, confirmar check-in âœ…', 'No, necesito cambiar algo']);
    }, 1200);
  } else {
    // Next question
    ciPhase = next;
    showTyping();
    setTimeout(() => {
      hideTyping();
      const step = CI_STEPS[next];
      addMessage('agent', `<div class="ci-card" style="background:linear-gradient(135deg,#4401ff,#6630ff)">${progressBar(next)}<div style="font-size:13px">${step.q}</div></div>`);
      if (step.hint) setSuggestions(step.hint);
    }, 900);
  }
}

function completeCheckIn() {
  ciPhase = 'done';
  clearSuggestions();
  const roomKey = 'KEY-' + Math.floor(1000 + Math.random() * 9000);
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMessage('agent', `<div class="ci-card">
      <div class="ci-card-title">âœ… Check-in Completo!</div>
      <div class="ci-row"><span>HuÃ©sped</span><span>${ciData.name}</span></div>
      <div class="ci-row"><span>HabitaciÃ³n</span><span>Deluxe â€” Vista ciudad</span></div>
      <div class="ci-row"><span>Check-in</span><span>Vie 21 Feb Â· desde ${ciData.arrival}</span></div>
      <div class="ci-row"><span>Check-out</span><span>SÃ¡b 22 Feb Â· 11:00</span></div>
      <div class="ci-key">
        <div class="key-icon">ğŸ”‘</div>
        <div>
          <div class="key-text">Tu Llave Digital</div>
          <div class="key-num">${roomKey}</div>
          <div class="key-text" style="margin-top:2px">Mostrala en recepciÃ³n o usÃ¡ la app</div>
        </div>
      </div>
    </div>
    <br>Â¡Bienvenido/a a Hotel Palermo Soho, <strong>${ciData.name.split(' ')[0]}</strong>! ğŸŒŸ AndÃ¡ directo a tu habitaciÃ³n â€” sin cola en recepciÃ³n. Â¡Te esperamos!`);
    setTimeout(() => {
      addMessage('agent', `Si necesitÃ¡s algo antes o durante tu estadÃ­a, estoy disponible 24/7. Â¿Hay algo mÃ¡s que pueda organizar?`);
      setSuggestions(['Horario de pileta?', 'Puedo pedir cena?', 'Necesito taxi del aeropuerto']);
    }, 1000);
  }, 2000);
}

function replyWithIntent(intent) {
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMessage('agent', intent.reply);
    if (intent.follow && intent.follow.length) {
      setTimeout(() => {
        setSuggestions([
          ...intent.follow,
          { label: 'Otra consulta', action: () => {
            clearSuggestions();
            addMessage('agent', `Â¡Por supuesto! Â¿En quÃ© mÃ¡s puedo ayudarte? ğŸ˜Š`);
            setSuggestions(['Clave de WiFi?','Horario de pileta?','Room service','Necesito un taxi']);
          }}
        ]);
      }, 500);
    }
  }, 1300);
}

// â”€â”€ AGENT 3: UPSELLING â”€â”€
function initUpselling() {
  const ca = document.getElementById('chatArea');
  const banner = document.createElement('div');
  banner.className = 'revenue-banner';
  banner.innerHTML = `
    <div class="rev-label">Revenue Extra Este Mes</div>
    <div class="rev-amt" id="revAmt">$0</div>
    <div class="rev-sub">de conversiones de upselling Â· sesiÃ³n demo</div>`;
  ca.appendChild(banner);

  setTimeout(() => {
    addMessage('agent', `ğŸ‰ <strong>Â¡Reserva confirmada!</strong> Ya estÃ¡s listo/a para Feb 21â€“22.<br><br>SeleccionÃ© algunas <strong>ofertas exclusivas</strong> para vos â€” disponibles por tiempo limitado:`, '9:41');
    setTimeout(() => addUpsellCard('upgrade',  'ğŸ› Upgrade de HabitaciÃ³n', '+$80/noche', 'MejorÃ¡ a nuestra Deluxe â€” cama king, minibar, vista a la ciudad. Â¡Pocas disponibles!',                      80), 700);
    setTimeout(() => addUpsellCard('breakfast','ğŸ³ Desayuno Premium',      '$18/persona', 'EmpezÃ¡ cada maÃ±ana en Restaurant Nivel 1 con nuestro buffet premium. Jugos naturales, barista en mesa y opciones gourmet.', 36), 1200);
    setTimeout(() => addUpsellCard('checkout', 'ğŸ• Late Checkout',          '$30 total',  'Quedate hasta las 14:00 en lugar de las 11:00. DisfrutÃ¡ una maÃ±ana relajada sin apuros.',                                    30), 1700);
  }, 300);
}

function addUpsellCard(id, title, badge, desc, amount) {
  const ca = document.getElementById('chatArea');
  const card = document.createElement('div');
  card.className = 'upsell-card'; card.id = 'uc-' + id;
  card.innerHTML = `
    <div class="upsell-h">
      <span class="upsell-title">${title}</span>
      <span class="upsell-badge">${badge}</span>
    </div>
    <div class="upsell-body">
      <p class="upsell-desc">${desc}</p>
      <div class="upsell-actions" id="ua-${id}">
        <button class="btn-yes" onclick="acceptUpsell('${id}',${amount})">âœ“ SÃ­, agregalo!</button>
        <button class="btn-no"  onclick="declineUpsell('${id}')">No, gracias</button>
      </div>
    </div>`;
  ca.appendChild(card); scrollDown();
}

function acceptUpsell(id, amount) {
  const actions = document.getElementById('ua-' + id);
  const card    = document.getElementById('uc-' + id);
  actions.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#059669;font-weight:600;font-size:13px;padding:6px">âœ… Â¡Agregado a tu estadÃ­a!</div>`;
  card.style.borderColor = '#059669';
  revenue += amount;
  const el = document.getElementById('revAmt');
  if (el) { el.textContent = '$' + revenue; el.style.transform = 'scale(1.25)'; setTimeout(()=>el.style.transform='',250); }
  const msgs = {
    upgrade:   `ğŸ› Â¡Upgrade a Deluxe confirmado! Una botella de espumante te va a estar esperando. Â¡No sabÃ©s la vista que te espera! ğŸ¥‚`,
    breakfast: `ğŸ³ Â¡Desayuno premium agregado! Nos vemos maÃ±ana en Restaurant Nivel 1. RecomendaciÃ³n del chef: huevos benedictinos con salmÃ³n ahumado ğŸ˜‹`,
    checkout:  `ğŸ• Â¡Late checkout hasta las 14:00 confirmado! Ya actualicÃ© tu reserva. DisfrutÃ¡ tu maÃ±ana extra ğŸ˜Š`,
  };
  setTimeout(() => addMessage('agent', msgs[id]), 450);
}

function declineUpsell(id) {
  const actions = document.getElementById('ua-' + id);
  const card    = document.getElementById('uc-' + id);
  actions.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#666666;font-size:12px;padding:6px">Sin problema â€” oferta declinada.</div>`;
  card.style.opacity = '0.5';
}

function handleUpsellingMsg(text) {
  showTyping();
  setTimeout(() => {
    hideTyping();
    addMessage('agent', `Â¡Gracias por tu mensaje! Â¿QuerÃ©s saber mÃ¡s sobre alguna de nuestras ofertas? Con gusto te cuento ğŸ˜Š`);
  }, 1100);
}

// â”€â”€ ROI CALCULATOR â”€â”€
function updateROI() {
  rooms = parseInt(document.getElementById('roomsSlider').value);
  document.getElementById('roomsValue').textContent = rooms + ' habitaciones';
  const hrs = Math.round(rooms * 0.56);
  const rev = Math.round(rooms * 110);
  document.getElementById('hoursValue').innerHTML    = hrs + '<span class="roi-unit"> hrs</span>';
  document.getElementById('revenueValue').textContent = '$' + rev.toLocaleString();
  document.getElementById('totalValue').textContent   = '$' + rev.toLocaleString() + '/mes';
}

// â”€â”€ INPUT EVENTS â”€â”€
document.getElementById('msgInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendFromInput();
});
document.getElementById('msgInput').addEventListener('input', updateSendBtn);
document.getElementById('sendBtn').addEventListener('click', () => {
  const val = document.getElementById('msgInput').value.trim();
  if (val) sendFromInput();
  // if empty, mic icon â€” do nothing
});

// â”€â”€ BOOT â”€â”€
initReservations();
updateROI();
setTimeout(() => document.getElementById('msgInput').focus(), 200);
</script>
</body>
</html>
